### ğŸ§© Milestone: PolÃ­ticas RLS en participantes_grupo
- Se confirma que la tabla exige `usuario_id` y `invitado_por` para cumplir RLS.
- PolÃ­ticas activas:
  - INSERT â†’ `auth.uid() = invitado_por`
  - SELECT â†’ acceso solo a propios/invitados
  - UPDATE â†’ solo el invitador puede modificar
  - DELETE â†’ solo el invitador puede eliminar
- Se ajusta el flujo CrearGrupo para incluir estos campos en cada insert.
- Se asegura trazabilidad y seguridad institucional en Supabase.


### ğŸ§© Milestone: Cumplimiento de polÃ­ticas RLS en participantes_grupo
- Se confirma que las polÃ­ticas exigen que solo el admin autenticado pueda insertar, editar o eliminar.
- Se ajusta el insert para incluir:
  - grupo_id
  - usuario_id (UUID desde tabla usuarios)
  - correo
  - rol
  - fecha_ingreso
  - estado
  - invitado_por (auth.uid())
- Se asegura que los registros cumplan las polÃ­ticas y se inserten correctamente.
- Se consolida la trazabilidad institucional en Supabase.


### ğŸ§© Milestone: SeparaciÃ³n de identidad y vÃ­nculo en Finedu
- Se confirma que `nombre + apellido` se obtiene desde la tabla `usuarios`.
- La tabla `participantes_grupo` no guarda nombre/apellido, solo referencia con `usuario_id`.
- La interfaz muestra nombre completo gracias a la consulta previa a `usuarios`.
- Se asegura trazabilidad institucional: identidad en `usuarios`, vÃ­nculo en `participantes_grupo`.


### ğŸ§© Milestone: Ajuste CrearGrupo para cumplir RLS
- Se elimina `nombre_apellido` del insert (no existe en la tabla).
- Se agrega `usuario_id` recuperado desde `usuarios`.
- Se agrega `invitado_por` con `auth.uid()` del admin autenticado.
- Se inicializan `fecha_ingreso` y `estado`.
- Se asegura que los inserts en `participantes_grupo` cumplan las polÃ­ticas RLS y se registren correctamente.


# ğŸ“Œ Milestone â€” Flujo de Participantes (Finedu)

## ğŸ“Š Tabla comparativa global

| Elemento                  | QuÃ© hace actualmente                          | QuÃ© deberÃ­a hacer                         | Desfase detectado                  |
|----------------------------|-----------------------------------------------|-------------------------------------------|------------------------------------|
| Tabla participantes_grupo  | Campos: id, grupo_id, usuario_id, correo, rol | Insertar usuario_id + invitado_por         | No existe columna nombre_apellido   |
| CrearGrupo.tsx             | Inserta correo + rol + nombre_apellido        | Insertar usuario_id + invitado_por         | Inserta campo inexistente           |
| agregarParticipanteNuevo.ts| Valida sesiÃ³n, busca usuario, inserta completo| Cumple con tabla y RLS                     | Correcto                            |
| FormularioAgregar.tsx      | Llama a agregarParticipante con adminId extra | Pasar solo grupoId + correo                | Desfase de parÃ¡metros               |
| TablaParticipantes.tsx     | Renderiza lista, espera join con usuarios     | Mostrar nombre/apellido desde usuarios     | Depende de usuario_id correcto      |
| verParticipantesNuevo.ts   | Valida acceso, hace join con usuarios         | Correcto                                   | Correcto                            |

---

## ğŸ” Resumen diagnÃ³stico

- **Backend (Supabase)** â†’ Correcto, tabla y polÃ­ticas RLS bien configuradas.  
- **`agregarParticipanteNuevo.ts` y `verParticipantesNuevo.ts`** â†’ Correctos, cumplen con la tabla y RLS.  
- **`FormularioAgregar.tsx`** â†’ Desfase de parÃ¡metros: pasa `adminId` innecesario.  
- **`TablaParticipantes.tsx`** â†’ Correcta en lÃ³gica, pero depende de que `usuario_id` se inserte bien.  
- **`CrearGrupo.tsx`** â†’ Principal desfase: inserta campo inexistente (`nombre_apellido`) y no incluye `usuario_id` ni `invitado_por`.  

ğŸ‘‰ El **problema real** estÃ¡ en `CrearGrupo.tsx`: los inserts no cumplen la estructura ni las polÃ­ticas RLS, por eso los participantes no se registran y los nombres no aparecen en la tabla.

---

## ğŸ¯ Acciones a tomar

1. **Corregir `CrearGrupo.tsx`**  
   - Eliminar `nombre_apellido` del insert.  
   - Incluir `usuario_id` (recuperado desde `usuarios`) y `invitado_por` (`auth.uid()`).  
   - Inicializar `estado = "activo"` y `fecha_ingreso = new Date().toISOString()`.  

2. **Ajustar `FormularioAgregar.tsx`**  
   - Llamar a `agregarParticipante(grupoId, correo)` sin pasar `adminId`.  
   - Dejar que la funciÃ³n obtenga `auth.uid()` directamente.  

3. **Validar flujo en Supabase**  
   - Crear grupo de prueba y verificar que cada registro en `participantes_grupo` tenga:  
     - `usuario_id` correcto  
     - `correo` correcto  
     - `rol` asignado  
     - `estado = activo`  
     - `invitado_por = auth.uid()`  

4. **Confirmar visualizaciÃ³n en `TablaParticipantes.tsx`**  
   - Revisar que el join con `usuarios` muestre nombre+apellido correctamente.  


# ğŸ“Œ Milestone Institucional â€” Tablas y PolÃ­ticas RLS (Finedu)

## ğŸ“Š Comparativa Global (ordenada alfabÃ©ticamente)

| Tabla               | Estado actual | Desfase principal | AcciÃ³n clave |
|----------------------|---------------|------------------|--------------|
| **grupos_ahorro**    | Admin guardado como correo, polÃ­ticas bÃ¡sicas | `administrador_id` debe ser uuid, SELECT demasiado abierto | Guardar `auth.uid()` en `administrador_id`, restringir SELECT a participantes vinculados |
| **historial_grupo**  | Admin inserta, participantes leen | SELECT demasiado abierto | Restringir SELECT a participantes vinculados al grupo |
| **metadata_grupo**   | Solo admin puede modificar, pero SELECT abierto a `public` | Cualquiera puede leer metadata | Restringir SELECT a admin y participantes del grupo |
| **participantes_grupo** | Insert con correo en vez de uuid, polÃ­ticas correctas | Join falla, nombres no aparecen | Insertar `usuario_id = uuid`, `invitado_por = auth.uid()` |
| **usuarios**         | RLS deshabilitado, polÃ­ticas abiertas con `public` | Se guarda correo en vez de uuid, polÃ­ticas duplicadas y sin restricciÃ³n real | Habilitar RLS, usar `auth.uid()` como clave, limpiar polÃ­ticas |

---

## ğŸ” DiagnÃ³stico Ãšnico

- **Inconsistencia de identificadores**  
  - Se estÃ¡n guardando correos en campos que esperan `uuid`.  
  - Esto rompe los joins y las validaciones RLS.  

- **RLS deshabilitado en `usuarios`**  
  - Aunque hay polÃ­ticas, no se aplican.  
  - AdemÃ¡s, estÃ¡n definidas con `public` en vez de `authenticated`.  

- **PolÃ­ticas demasiado abiertas en `metadata_grupo` y `historial_grupo`**  
  - Permiten lecturas sin validar vÃ­nculo real con el grupo.  

- **Resultado visible en la app**  
  - Los nombres no aparecen en la tabla de participantes.  
  - Siempre se muestra â€œâš ï¸ El correo ingresado no estÃ¡ registradoâ€.

---

## ğŸ¯ Acciones Concretas

1. **Unificar identificadores**  
   - Guardar siempre `administrador_id` y `usuario_id` como `auth.uid()` (uuid).  
   - Usar `correo` solo como auxiliar, nunca como clave de relaciÃ³n.  

2. **Habilitar y ajustar RLS en `usuarios`**  
   - Activar RLS.  
   - Redefinir polÃ­ticas con `authenticated` y `auth.uid()`.  

3. **Restringir SELECT en `metadata_grupo` y `historial_grupo`**  
   - Solo admin y participantes vinculados deben poder leer.  

4. **Validar integridad referencial**  
   - Agregar foreign keys:  
     - `grupo_id` â†’ `grupos_ahorro(id)`  
     - `usuario_id` â†’ `usuarios(id)`  

5. **Alinear inserts en React**  
   - Al crear grupo: `administrador_id = auth.uid()`.  
   - Al agregar participante: buscar `uuid` en `usuarios` por correo y usarlo en `usuario_id`.  
   - Insertar tambiÃ©n `invitado_por = auth.uid()`.

---

## ğŸ“Œ Estado del Milestone

- **Responsable:** Wilson Contreras  
- **Fecha:** 12 de noviembre de 2025  
- **Estado:** DiagnÃ³stico completado.  
- **Pendiente:** aplicar bloque SQL de correcciÃ³n en Supabase y validar en la app (crear grupo, agregar participante, visualizar, expulsar).  

# ğŸ“Œ Milestone Institucional â€” ValidaciÃ³n de Tablas y PolÃ­ticas RLS (Finedu)

## ğŸ¯ Objetivo
Validar que las tablas y polÃ­ticas RLS funcionan correctamente despuÃ©s de aplicar el bloque SQL de correcciÃ³n.  
El checklist asegura que los inserts, selects y relaciones se comporten como corresponde en la app y en Supabase.

---

## âœ… Checklist de ValidaciÃ³n

### 1. Tabla `usuarios`
- [?] Crear un nuevo usuario â†’ se inserta correctamente con `id (uuid)` generado.  
- [x] Intentar leer otro perfil â†’ acceso denegado.  
- [ok] Leer mi propio perfil â†’ acceso permitido.  
- [x] Actualizar mis datos â†’ acceso permitido solo si `id = auth.uid()`.

---

### 2. Tabla `grupos_ahorro`
- [?] Crear grupo â†’ `administrador_id = auth.uid()` se guarda como uuid, no correo.  
- [?] Insertar admin automÃ¡ticamente en `participantes_grupo` con rol = admin.  
- [ok] Participante autenticado puede ver solo los grupos donde estÃ¡ vinculado.  
- [ok] Intentar modificar/eliminar grupo siendo admin â†’ acceso permitido.  
- [x] Intentar modificar/eliminar grupo siendo participante â†’ acceso denegado.

---

### 3. Tabla `metadata_grupo`
- [ok] Insertar metadata de un grupo â†’ permitido solo para admin.  
- [ok] Actualizar metadata â†’ permitido solo para admin.  
- [ok] Eliminar metadata â†’ permitido solo para admin.  
- [ok] Participante autenticado puede leer metadata solo de los grupos donde estÃ¡ vinculado.  
- [x] Usuario no vinculado â†’ acceso denegado.

---

### 4. Tabla `participantes_grupo` (la tabla es aporte_grupales)
- [x] Insertar participante â†’ `usuario_id = uuid` correcto, `correo` solo auxiliar.  
- [x] `invitado_por = auth.uid()` se guarda como uuid.  
- [ok] Participante puede ver su vÃ­nculo en el grupo.  
- [ok] Admin puede ver todos los participantes de su grupo.  
- [x] Intentar insertar participante con correo en vez de uuid â†’ falla (validaciÃ³n correcta).  
- [ok] Intentar eliminar participante siendo admin â†’ acceso permitido.  
- [ok] Intentar eliminar participante siendo participante â†’ acceso denegado.

---

### 5. Tabla `historial_grupo`
- [ok] Insertar evento â†’ permitido solo para admin (`usuario_id = auth.uid()`).  
- [ok] Participante autenticado puede leer historial solo de los grupos donde estÃ¡ vinculado.  
- [x] Usuario no vinculado â†’ acceso denegado.  
- [x] Validar que `grupo_id` y `usuario_id` respetan las foreign keys (no se insertan registros huÃ©rfanos).

---

## ğŸ“Œ Estado del Milestone
- **Responsable:** Wilson Contreras  
- **Fecha:** 12 de noviembre de 2025  
- **Estado:** Checklist preparado.  
- **Pendiente:** Ejecutar pruebas en Supabase y en la app, registrar resultados en bitÃ¡cora institucional.  


ğŸ“Œ Checklist Institucional Finedu â€” Seguridad y Trazabilidad
Tabla usuarios
RLS habilitado

PolÃ­ticas creadas:
Permitir registro de usuarios (INSERT)
Usuario puede ver su perfil (SELECT)
Usuario puede actualizar su perfil (UPDATE)
Usuario puede actualizar solo campos permitidos (UPDATE restringido)

Triggers:
BEFORE UPDATE â†’ bloquea cambios en id y correo
AFTER UPDATE â†’ registra auditorÃ­a en auditoria_usuarios
Integridad referencial:
usuarios.id es PK y referencia central para todas las demÃ¡s tablas
Tabla grupos_ahorro
RLS habilitado

PolÃ­ticas creadas:
Admin puede crear grupo (INSERT)
Admin puede editar grupo (UPDATE)
Admin puede eliminar grupo (DELETE)
Participantes y admin pueden ver grupo (SELECT)
Integridad referencial:
administrador_id â†’ usuarios.id
Tabla participantes_grupo
RLS habilitado

PolÃ­ticas creadas:
Admin puede insertar participante (INSERT)
Admin puede actualizar participante (UPDATE)
Admin puede eliminar participante (DELETE)
Ver vÃ­nculo si soy participante o admin (SELECT)
Integridad referencial:
usuario_id â†’ usuarios.id
grupo_id â†’ grupos_ahorro.id
Tabla metadata_grupo
RLS habilitado

PolÃ­ticas creadas:
Admin puede insertar metadata (INSERT)
Admin puede actualizar metadata (UPDATE)
Admin puede eliminar metadata (DELETE)
Participantes pueden ver metadata (SELECT)

Integridad referencial:
grupo_id â†’ grupos_ahorro.id
Tabla historial_grupo
RLS habilitado

PolÃ­ticas creadas:
Admin puede registrar eventos (INSERT)
Participantes pueden ver historial (SELECT)
Integridad referencial:
grupo_id â†’ grupos_ahorro.id
usuario_id â†’ usuarios.id

ğŸ“Œ Resultado institucional
Todas las tablas tienen RLS habilitado.
PolÃ­ticas alineadas con la visiÃ³n Finedu: administrador controla, participantes leen.
Triggers y auditorÃ­a garantizan trazabilidad en usuarios.
Integridad referencial asegura que no existan registros huÃ©rfanos.
Documento listo para ser guardado como ChecklistSeguridadFinedu.md en tu repositorio.




# ğŸ“ Milestone Institucional: IntegraciÃ³n de UserContext en Finedu

## âœ… Cambios aplicados

- **App.tsx**
  - Se envolviÃ³ toda la aplicaciÃ³n con `<UserProvider>`.
  - Se eliminÃ³ la dependencia de `usuarioCorreo` y se integrÃ³ `useUserPerfil`.
  - Se pasÃ³ el perfil completo (nombre, apellido, correo) a los mÃ³dulos que lo requieren.

- **Navbar.tsx**
  - Se eliminÃ³ el uso de `localStorage`.
  - Se integrÃ³ `useUserPerfil` para mostrar el nombre + apellido del usuario activo.
  - El identificador aparece en todas las pantallas.

- **PanelAhorro.tsx**
  - Se eliminÃ³ la prop `usuario`.
  - Se integrÃ³ `useUserPerfil` para mostrar el nombre + apellido en el header.
  - Se pasa el correo del perfil al componente `CrearGrupo`.

- **CrearGrupo.tsx**
  - Se eliminÃ³ la prop `usuario`.
  - Se integrÃ³ `useUserPerfil` para mostrar el administrador en el encabezado.
  - Se usa el correo del perfil para la lÃ³gica de creaciÃ³n del grupo.

- **BloqueParticipantes.tsx**
  - Se integrÃ³ `useUserPerfil` para mostrar el nombre + apellido real del administrador.
  - Los participantes muestran nombre + apellido recuperado desde Supabase.

- **BloqueMetaFinanciera.tsx**
  - Se integrÃ³ `useUserPerfil` para mostrar el administrador junto con la meta financiera.
  - Se refuerza la trazabilidad institucional en los cÃ¡lculos.

- **BloqueDatosGrupo.tsx**
  - Se integrÃ³ `useUserPerfil` para mostrar el administrador en los datos generales del grupo.

---

## ğŸ“Œ Resultado esperado

- El **usuario activo** aparece con nombre + apellido en todas las pantallas clave:
  - Navbar
  - PanelAhorro
  - CrearGrupo
  - BloqueParticipantes
  - BloqueMetaFinanciera
  - BloqueDatosGrupo
- Se elimina la dependencia de `localStorage`.
- Se asegura trazabilidad institucional y consistencia en la experiencia de usuario.

---

## ğŸš€ PrÃ³ximo paso sugerido

- Documentar este milestone en `estadoConstruccionFinedu.md`.
- Validar en Vercel que todos los mÃ³dulos muestran correctamente el nombre + apellido del usuario activo.
- Registrar este avance como **Milestone de IntegraciÃ³n de Contexto de Usuario** en la bitÃ¡cora institucional.

